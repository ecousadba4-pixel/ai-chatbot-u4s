name: Update Vector Store from kb.jsonl

on:
  push:
    branches: [ "main" ]
    paths:
      - "kb.jsonl"
      - "scripts/refresh_vector_store_files.py"
      - ".github/workflows/update-vector-store.yml"
  workflow_dispatch:

permissions:
  contents: write   # нужно, чтобы шаг с обновлением README мог пушить

concurrency:
  group: vector-store-${{ github.ref }}
  cancel-in-progress: true

jobs:
  update:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Verify kb.jsonl exists
        run: test -s kb.jsonl

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          pip install --upgrade pip
          pip install openai

      - name: Refresh Vector Store (soft update)
        env:
          YANDEX_API_KEY: ${{ secrets.YANDEX_API_KEY }}
          VECTOR_STORE_ID: ${{ secrets.VECTOR_STORE_ID }}
          YANDEX_FOLDER_ID: b1g2vuvi3is4jn4eamo0
        run: |
          python scripts/refresh_vector_store_files.py \
            --vs-id "$VECTOR_STORE_ID" \
            --kb "kb.jsonl" \
            --folder-id "$YANDEX_FOLDER_ID" \
            --timeout 900

      - name: Update README timestamp
        continue-on-error: true
        run: |
          SYNC_DATE=$(date -u +"%Y-%m-%d %H:%M UTC")
          echo "Last KB Sync: ${SYNC_DATE}" | tee -a "$GITHUB_STEP_SUMMARY"
          if grep -q "Last KB Sync:" README.md; then
            sed -i "s|Last KB Sync: .*|Last KB Sync: ${SYNC_DATE}|" README.md
          else
            printf "\nLast KB Sync: ${SYNC_DATE}\n" >> README.md
          fi
          git config --global user.email "actions@github.com"
          git config --global user.name "github-actions"
          git add README.md
          git commit -m "docs: update last KB sync date (${SYNC_DATE})" || true
          git push
